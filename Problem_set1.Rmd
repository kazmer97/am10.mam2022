---
title: "Problem Set 1"
author: "Kazmer Nagy-Betegh"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    highlight: zenburn
    number_sections: true
    toc: yes
    toc_float: yes
---


# JP Morgan Visualisation Grade
| Rubric | grade |
|------------------------------------------------------------------|-------|
| 6-12 word descriptive title is left-justified in upper left corner | 1 |
| Subtitle and/or annotations provide additional information | 2 |
| Text size is hierarchical and readable | 2 |
| Text is horizontal | 2 |
| Data are labeled directly | 1 |
| Labels are used sparingly | 2 |
| Proportions are accurate | 2 |
| Data are intentionally ordered | 1 |
| Axis intervals are equidistant | 2 |
| Graph is two-dimensional | 2 |
| Display is free from decoration | 2 |
| Color scheme is intentional | 0 |
| Color is used to highlight key patterns | 0 |
| Color is legible when printed in black and white | 0 |
| Color is legible for people with colorblindness | 0 |
| Text sufficiently contrasts background | 2 |
| Gridlines, if present, are muted | 1 |
| Graph does not have border line | 2 |
| Axes do not have unnecessary tick marks or axis lines | 2 |
| Graph has one horizontal and one vertical axis | 2 |
| Graph highlights significant finding or conclusion | 2 |
| The type of graph is appropriate for data | 2 |
| Graph has appropriate level of precision | 2 |
| Individual chart elements work together to reinforce the overarching takeaway message | 2 |

# Worst Possible Visualisation

```{r}

```


 
# MET Police

```{r load met data}

stop_search_2020 <- data.frame()

for(i in 5:9){
  temp <- readr::read_csv(here::here("data","stop-search",paste0("2020-0",i),paste0("2020-0",i,"-metropolitan-stop-and-search.csv")))
  stop_search_2020 <- rbind(stop_search_2020, temp)
}

```

```{r}
library(readxl)
library(dplyr)
library(stringr)
# load 2021 September data
stop_search_2021 <- readr::read_csv(here::here("data","stop-search","2021-09","2021-09-metropolitan-stop-and-search.csv"))

ward_population <- read_excel(path = here::here("data","/London-wards-2018_ESRI/CT0225_2011 Census - Age by ethnic group (based on CT0010) by sex - London HT wards.xlsx"),
                              sheet = "CT0225 - All usual residents",
                              skip = 11,
                              col_names = T,
                              range = "A11:VA674")%>%
  janitor::clean_names()

for(i in 4:573){
  if(!is.na(ward_population[1,i])){
    temp <- ward_population[1,i]
  }
  else{
    ward_population[1,i] <- temp
  }
}

names(ward_population)[4:length(ward_population)] <- paste0(ward_population[1,],"_",ward_population[2,])[4:length(ward_population)]

ward_population <- ward_population%>%
  janitor::clean_names()

ward_population <- ward_population[-c(1,2),]

ward_population <- ward_population%>%
  # rename(area_code = x1,
  #        area_name = x2,
  #        total_population = x3)%>%
  mutate(area_code = case_when(!is.na(x1) ~ str_split_fixed(ward_population$x1," ",2)[,1],
                               TRUE ~ str_split_fixed(ward_population$x2," ",2)[,1]),
         .after = x1,
         area_name = case_when(!is.na(x1) ~ str_split_fixed(ward_population$x1," ",2)[,2],
                               TRUE ~ str_split_fixed(ward_population$x2," ",2)[,2]),
         population_total = x3)

ward_population <-  subset(ward_population, select = -c(x1,x2,x3))
```

```{r}
skimr::skim(stop_search_2021)
```


```{r visualisation-1}
library(leaflet)
library(sf)
library(ggplot2)
library(dplyr)
library(spatialEco)
library(leaflet.extras)


# read in the shapefile, transform it into long lat format

wards <- st_read(here::here("data/London-wards-2018_ESRI/London_Ward_CityMerged.shp"))

wards <- st_transform(wards,crs=4326)

stops_sf <- st_as_sf(stop_search_2021%>%select(Longitude, Latitude)%>%na.omit,coords = c('Longitude',"Latitude"), crs = st_crs(map))

stop_locations <- stops_sf %>% 
  mutate(intersection = as.integer(st_intersects(geometry, wards$geometry)),
         area = if_else(is.na(intersection), '', wards$NAME[intersection])) 

stop_locations <- stop_locations%>%
  mutate(X= st_coordinates(geometry)[,1],
         Y= st_coordinates(geometry)[,2])

stop_search_2021 <- left_join(stop_search_2021, stop_locations, by = c("Longitude" = "X","Latitude" = "Y" ))

stop_search_2021_wards <- left_join(stop_search_2021, wards, by = c("area"= "NAME"))

stop_search_2021_wards <- stop_search_2021_wards%>%
  rename(point_geometry = geometry.x,
         geometry = geometry.y)

# stop_search_2021_wards <- st_transform(stop_search_2021_wards,crs=4326)

pal <-  colorNumeric("OrRd", stop_locations$intersection)


map_london <- leaflet()%>%
  addTiles(
    options = tileOptions(minZoom = 10, maxZoom = 15)
    )%>%
  addControl("London Stop and Search Frequency", position = 'bottomleft')%>%
  setMaxBounds(lng1 = -0.147949,
               lng2 = -0.117949,
               lat1 = 51.20775,
               lat2 = 51.70775)%>%
  addPolygons(data = wards,
              color = 'blue',
              fillOpacity = 0.05,
              weight = 0.5,
              fill = ,
              popup = ~paste0(NAME," num. stops: ",stop_locations$intersection[which(stop_locations$area == NAME)]))%>%
  addHeatmap(group = "heat",
             data = stop_locations%>%na.omit,
             lng = ~as.numeric(stop_locations$X),
             lat = ~as.numeric(stop_locations$Y),
             intensity = stop_locations$intersection,
             radius = 6,
             minOpacity = 0.08,
             max = 0.7,
             gradient = "OrRd")%>%
  addLegend(values = stop_locations$intersection%>%na.omit,
            group = "heat",
            pal =  colorNumeric("OrRd",stop_locations$intersection),
            title = "Number of Stop and Searches")

  
  
  

map_london
```


```{r, ward population}

indx_black <- grepl('black', colnames(ward_population))

black_pop_total<-rowSums(data.frame(lapply(ward_population[which(indx_black)], as.numeric)))

ward_population_no_age <- ward_population%>%
  mutate(black_population = black_pop_total,
         population_total = as.numeric(population_total))%>%
  select(area_code,
         area_name,
         population_total,
         black_population)%>%
  mutate(prc_black = black_population/population_total)

stop_search_2021_wards <- stop_search_2021_wards%>%select(-c("geometry"))


stop_search_2021_wards_pop <- left_join(stop_search_2021_wards,ward_population_no_age, by = c("LAGSSCODE" = "area_code"))

stop_search_2021_wards_pop <- stop_search_2021_wards_pop%>%
  janitor::clean_names()

```


```{r}

stop_search_2021_wards_pop%>%
  mutate(black_or_not = case_when(officer_defined_ethnicity == "Black" ~ 1,
                                 TRUE ~ 0))%>%
  group_by(black_or_not)%>%
  summarise(num_stops = n()
            )%>%
  mutate(prc_stopped_black = num_stops/sum(num_stops))%>%
  ggplot()+
    geom_col(aes(x = black_or_not, y = prc_stopped_black), 
             fill = 'tan',
             alpha = 1)+
  geom_col(aes(x = c(0,1), y =c(0.962, 0.038)), 
             fill = 'skyblue',
           alpha = 0.4)+
  theme_bw()
  
    
  
           


```

